name: Publish to npm

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'run-ci.sh'
      - 'bin/cli.js'
      - '.github/workflows/publish-npm.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Determine version bump
        id: version
        run: |
          # Read current version from VERSION file
          CURRENT=$(cat VERSION | tr -d '\n' | xargs)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          # Get commit messages since last tag (if any)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%B" 2>/dev/null || git log --pretty=format:"%B" | head -20)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          
          # Determine version bump type
          if echo "$COMMITS" | grep -qi "breaking change\|^break"; then
            BUMP="major"
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMITS" | grep -qi "feat:"; then
            BUMP="minor"
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            BUMP="patch"
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP → $NEW_VERSION"
      
      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.new_version }}" > VERSION
      
      - name: Update CHANGELOG.md
        run: |
          DATE=$(date +%Y-%m-%d)
          NEW_VERSION=${{ steps.version.outputs.new_version }}
          
          # Create temp changelog
          {
            head -n 14 CHANGELOG.md
            echo ""
            echo "## [$NEW_VERSION] - $DATE"
            echo ""
            echo "### Changed"
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD")..HEAD | head -20
            echo ""
            tail -n +15 CHANGELOG.md
          } > CHANGELOG.md.tmp
          
          mv CHANGELOG.md.tmp CHANGELOG.md
      
      - name: Update package.json
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.version.outputs.new_version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
      
      - name: Verify scripts exist
        run: |
          test -f run-ci.sh || { echo "run-ci.sh not found"; exit 1; }
          test -f bin/cli.js || { echo "bin/cli.js not found"; exit 1; }
          test -f package.json || { echo "package.json not found"; exit 1; }
          test -f VERSION || { echo "VERSION not found"; exit 1; }
          echo "✅ All required files present"
      
      - name: Publish to npm
        run: |
          npm publish --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add VERSION CHANGELOG.md package.json
          git commit -m "chore: release v${{ steps.version.outputs.new_version }}"
          git tag "v${{ steps.version.outputs.new_version }}"
          git push origin main --tags
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body: |
            Published to npm: https://www.npmjs.com/package/@orchestrate-solutions/universal-ci/v${{ steps.version.outputs.new_version }}
            
            Version bump: ${{ steps.version.outputs.bump }}
            
            See CHANGELOG.md for details.
          generate_release_notes: false
